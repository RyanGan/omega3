---
title: "Omega-3 and Inflammatory Arthritis Analysis"
author: "Ryan_Gan"
date: "January 23, 2017"
output: html_document
---

## Purpose of Markdown Document

This document contains the code used to produce the results for the paper, *The association between omega-3 fatty acid biomarkers and inflammatory arthritis in an at-risk population positive for anti-citrullinated protein antibodies.*

Calling libraries used for data manipulation and analysis.
```{r libraries, message=F, warning=F}

library(tidyverse) # data wrangling 
library(broom) # analysis object to tidy dataframe
library(survival) # time-varying model
library(knitr) # for kable function

```

## Baseline Visit Cross-Sectional Analysis

Code and results for the cross-sectional analysis of baseline inflammatory arthritis (IA) prevalence and the association with omega-3 fatty acid (n-3 FA) biomarker, n-3 FA percentage of red blood cells (n-3 FA % in RBCs).

### Data Import

Reading baseline dataframe Elizabeth provided. There are 52 observations with 56 variables. Elizabeth limited dataframe to relevant variables and imputed some missing variables based on prior observations on the same subject.

```{r read baseline dataframe, message=F, warning=F}

# reading baseline data
baseline_df <- read_csv("baseline.csv") %>% 
  rename(visit_num = visit_)

```

### Descriptive Table 1 by IA Status (Table 1)

Creating Table 1 of descriptive characteristics by baseline IA status. First step is creating an empty matrix and calculating cell values for each variable.

```{r table 1, message=F, warning=F, results='asis'}

# create empty dataframe of table 1
table1_matrix <- matrix(nrow = 14, ncol = 8, byrow = T)
# define column names for matrix
colnames(table1_matrix) <- c("variable", "ia_yes_n", "ia_yes_val", "ia_yes_parenth",
                             "ia_no_n", "ia_no_val", "ia_no_parenth", "p_val")

# fill column 1 with variable names
table1_matrix[,1] <- c("n", "Age (Mean)", "Age > 50 %", "Female %", 
  "Non-Hispanic White %","Education > HS %", "Income > 40k %", "Pack Years > 10 %", 
  "SE+ %", "n-3 FA Supplement %", "Multivitamin %", "RF+ %", "CRP+ %", "CCP2+ %")

#Now I want to calculate test statistics for each row variable. 
# As age is a continous variable, I test the differences between IA positive and 
# IA negative at baseline using a t-test (in a linear model). For the 2x2 
# contingency table tests, I use Fisher's exact test as it should be approximate 
# to Persons chi-squared for sufficiently large sample sizes.

# calculat IA n and fill first row n
tab <- xtabs(~ ia_base,  data = baseline_df)
table1_matrix[1:2,2] <- tab[2]
table1_matrix[1:2,5] <- tab[1]

# fill in means and SDs for IA cases
table1_matrix[2,3] <- round(mean(baseline_df$age[baseline_df$ia_base==1]),1)
table1_matrix[2,4] <- round(sd(baseline_df$age[baseline_df$ia_base==1]),1)
# fill in means and SDs for IA no 
table1_matrix[2,6] <- round(mean(baseline_df$age[baseline_df$ia_base==0]),1)
table1_matrix[2,7] <- round(sd(baseline_df$age[baseline_df$ia_base==0]),1)
# calculate p val
# calculate p value for test of mean differences
age_p <- as.vector(tidy(lm(age ~ ia_base, baseline_df)) %>% 
  filter(term == "ia_base") %>% 
  select(p.value) %>% 
  round(., 3))
# fill test of mean difference in age p value
table1_matrix[2, 8] <- as.numeric(age_p)

# create loop to calculate p values for binary variables
# create vector of variables to loop
var_loop <- c("age_bi", "sex", "race_bi", "educ", "inc", "py10", "se_bi", 
              "omega3_bi", "multivits_bi", "rfneph", "crp", "ccp2")

for(i in 1:length(var_loop)){

  # create tab
  tab <- xtabs(as.formula(paste0("~ia_base +", var_loop[i])),
               data = baseline_df)
  #calculate and round proportion
  tab_prop <- round(prop.table(tab, 1),3)*100 
  
  # fill columns ----
  # n sample size 
  table1_matrix[i+2,2] <- tab[2,2] + tab[2,1]
  # fill IA yes columns
  table1_matrix[i+2,3] <- tab[2,2]
  # fill with proportion/percentage
  table1_matrix[i+2,4] <- tab_prop[2,2]
  
  # fill IA no columns
  # n same size
  table1_matrix[i+2,5] <- tab[1,2] + tab[1,1]
  # fill IA no but yes to variable column
  table1_matrix[i+2,6] <- tab[1,2]
  # fill with proportion/percentage
  table1_matrix[i+2,7] <- tab_prop[1,2]
  # perform fisher's exact test; will be approximate to chisq with 
  # large enough sample size
  fisher_p <- tidy(fisher.test(tab)) %>% select(p.value)
  # fill in matrix
  table1_matrix[i + 2, 8] <- round(as.numeric(fisher_p), 3)
  
}

# convert table 1 matrix to dataframe
table1_df <- data.frame(table1_matrix)

knitr::kable(table1_df, caption = paste0("Table 1: Demographic and descriptive",
  " characteristics of ACPA positive subjects by Inflammatory Arthritis", 
  " (IA) status at baseline"))

```

Table 1 suggests a significant difference in proportions in the IA yes vs IA no group for n-3 FA supplement use, RF positivity, and CRP positivity.

### Association Between n-3 FA % in RBCs and Prevalence of IA at Baseline Visit (Table 2)

The following code contains logistic regression models for each n-3 FA % in RBCs biomarker. n-3 FA % in RBC biomarkers are: ALA, EPA, DPA, DHA, EPA+DHA, and ALA+EPA+DPA+DHA = Total n-3 FA. n-3 FA % in RBC variables were standardized, where the standard deviation of each n-3 FA distribution was divide from the distribution to allow for a "1 SD increase"" interpreation across all n-3 FA variables. Adjustment variables were based on confounding variables for variables associated with IA either in the baseline visit in the cross-sectional analysis or the baseline visit in the incidence study. 

```{r logistic regression loop, message=F, warning=F, results='asis'}
# create empty matrix for table
tab2_matrix <- matrix(nrow = 6, ncol = 5 )
# column names of tables
colnames(tab2_matrix) <- c("n3_FA_RBC", "OR", "Lower_95_CI",
                           "Upper_95_CI", "p_value") 
# variables to loop through
n3_vars <- c("sd_ala", "sd_epa", "sd_dpa", "sd_dha", "sd_epa_dha",
             "sd_total_n3")

# fill first column of matrix with n3 vars
tab2_matrix[,1] <- c("ALA", "EPA", "DPA", "DHA", "EPA+DHA",
                     "Total n-3 FA")

# Iteration of logistic regression through n-3 FAs
for(i in 1:length(n3_vars)){
  # general logistc regression; using tidy from broom to output 
  # coeffecients
  log_reg_mod <- tidy(glm(as.formula(paste0("ia_base ~", 
                    paste(n3_vars[i], "omega3_bi", "py10", "rfneph", 
                          "crp", "se_bi", sep = "+"))),
                    data = baseline_df, family = "binomial"(link="logit"))) 
  
  # calculate odds ratio and 95% CI
  odds_ratio <- log_reg_mod %>% filter(term == n3_vars[i]) %>% 
    # estimate lower and upper 95% CI bounds
    mutate(lower_bound = estimate - (1.96*std.error),
           upper_bound = estimate + (1.96*std.error)) %>% 
    select(term, estimate, lower_bound, upper_bound, p.value)

  # fill ith row of table 2
  tab2_matrix[i,2:4] <- round(as.numeric(exp(odds_ratio[1, 2:4])),2)
  tab2_matrix[i,5] <- round(as.numeric(odds_ratio[1,5]),2)

}

# create table of logistic values
# convert table 1 matrix to dataframe
table2_df <- as.data.frame(tab2_matrix)
summary(table2_df)
knitr::kable(table2_df, caption = paste0("Table 2: Association between n-3",
  " fatty % in red blood cells (RBC) and inflammatory arthritis (IA) in ACPA",
  " positive subjects at baseline visit."))
```

Logistic regression models were all adjusted for n-3 fatty acid supplement use, pack years > 10, RF+, CRP+, and SE. The odds ratios represent the difference in odds of IA for a one standard deviation (SD) difference in the n-3 FA% in RBC. The SD for these variables are listed below: ALA: 0.15, EPA: 0.54, DPA: 0.46, DHA: 1.19, EPA and DHA: 1.58, Total-n3: 1.88.

Increasing DPA, EPA+DHA, and Total n-3 FAs were significantly associated with a lower prevalence of IA.

### Plot of Table 2

Figure representation of table 2.

```{r alternate figure 2,message=F, warning=F, results='asis'}
# convert to numeric
or_df <- tab2_matrix %>% as_data_frame() %>% 
  mutate(OR = as.numeric(OR), Lower_95_CI = as.numeric(Lower_95_CI),
         Upper_95_CI = as.numeric(Upper_95_CI), p_value = as.numeric(p_value))
summary

or_fig <- ggplot(or_df, aes(x = n3_FA_RBC, y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = Lower_95_CI, ymax = Upper_95_CI)) +
  scale_y_log10() +
    # plot theme
  theme(panel.background = element_rect(fill = 'white', colour = 'black'),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank())
or_fig
scale_y

print_plot <- ggplot(combined_point_est_df, 
                       aes(x = pm_method, y = odds_ratio, colour = pm_method)) +
    geom_point() + #geom_text(vjust = 0, nudge_x = 0.3) +
    geom_errorbar(aes(ymin=lower95, ymax=upper95), width = 0.2) +
    facet_wrap(~outcome, nrow = 3) +
    geom_hline(yintercept = 1, linetype=2) +
    #ggtitle('County-Level: Association Between PM2.5 \n from Wildfire Smoke on Hospitalizations') +
    ylab('Odds Ratio for 10Âµg/m^3 Increase in PM2.5') +
    xlab('Time-Stratified Within July to October Fire Season') +
    # plot theme
    theme(panel.background = element_rect(fill = 'white', colour = 'black'),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    # strip element
    strip.background = element_rect(colour=NA, fill=NA),
    panel.border = element_rect(fill = NA, color = "black"),
    # facet text size
    strip.text = element_text(size = 7),
    legend.text = element_text(size = 7),
    # axis element
    axis.text.x = element_blank(),
    axis.title.y = element_text(angle = 90))

  print(print_plot)
    

```

## Incident IA Time-Varying Analysis

Fill in descriptions of time-varying approach to analyze incident IA.

### Import Time-Varying Dataframe

Read in time-varying incident IA dataframe created by Elizabeth..

```{r read incident dataframe, message=F, warning=F}

# reading baseline data
timevarying_df <- read_csv("incident_timevary.csv") %>% 
  rename(visit_num = visit_) %>% 
  # code indicator of IA incident group at baseline
  mutate(incident_ia_base = ifelse(ia_cat == 2, 1, 0))

# make a dataframe of baseline characteristics for IA group
tv_base_df <- timevarying_df %>% filter(visit_num == 1)

```

### Descriptive Characteristics at Baseline Visit of IA Status (Table 3)

Calculate descriptive characteristics of incident IA dataframe by IA status at their baseline visit. I need to figure out how to handle correct income calculation in dataframe.

```{r table 3, message=F, warning=F}

# create empty dataframe of table 1
table3_matrix <- matrix(nrow = 14, ncol = 8, byrow = T)
# define column names for matrix
colnames(table3_matrix) <- c("variable", "ia_yes_n", "ia_yes_val", "ia_yes_parenth",
                             "ia_no_n", "ia_no_val", "ia_no_parenth", "p_val")

# fill column 1 with variable names
table3_matrix[,1] <- c("n", "Age (Mean)", "Age > 50 %", "Female %", 
  "Non-Hispanic White %","Education > HS %", "Income > 40k %", "Pack Years > 10 %", 
  "SE+ %", "n-3 FA Supplement %", "Multivitamin %", "RF+ %", "CRP+ %", "CCP2+ %")

#Now I want to calculate test statistics for each row variable. 
# As age is a continous variable, I test the differences between IA positive and 
# IA negative at baseline using a t-test (in a linear model). For the 2x2 
# contingency table tests, I use Fisher's exact test as it should be approximate 
# to Persons chi-squared for sufficiently large sample sizes.

# calculat IA n and fill first row n
tab <- xtabs(~ incident_ia_base,  data = tv_base_df)
table3_matrix[1:2,2] <- tab[2]
table3_matrix[1:2,5] <- tab[1]

# fill in means and SDs for IA cases
table3_matrix[2,3] <- round(mean(tv_base_df$age[tv_base_df$incident_ia_base==1]),1)
table3_matrix[2,4] <- round(sd(tv_base_df$age[tv_base_df$incident_ia_base==1]),1)
# fill in means and SDs for IA no 
table3_matrix[2,6] <- round(mean(tv_base_df$age[tv_base_df$incident_ia_base==0]),1)
table3_matrix[2,7] <- round(sd(tv_base_df$age[tv_base_df$incident_ia_base==0]),1)
# calculate p val
# calculate p value for test of mean differences
age_p <- as.vector(tidy(lm(age ~ incident_ia_base, tv_base_df)) %>% 
  filter(term == "incident_ia_base") %>% 
  select(p.value) %>% 
  round(., 3))
# fill test of mean difference in age p value
table3_matrix[2, 8] <- as.numeric(age_p)

# create loop to calculate p values for binary variables
# create vector of variables to loop
var_loop <- c("age_bi", "sex", "race_bi", "educ", "inc", "py10", "se_bi", 
              "omega3_bi", "multivits_bi", "rfneph", "crp", "ccp2")

for(i in 1:length(var_loop)){

  # create tab
  tab <- xtabs(as.formula(paste0("~incident_ia_base +", var_loop[i])),
               data = tv_base_df)
  #calculate and round proportion
  tab_prop <- round(prop.table(tab, 1),3)*100 
  
  # fill columns ----
  # n sample size 
  table3_matrix[i+2,2] <- tab[2,2] + tab[2,1]
  # fill IA yes columns
  table3_matrix[i+2,3] <- tab[2,2]
  # fill with proportion/percentage
  table3_matrix[i+2,4] <- tab_prop[2,2]
  
  # fill IA no columns
  # n same size
  table3_matrix[i+2,5] <- tab[1,2] + tab[1,1]
  # fill IA no but yes to variable column
  table3_matrix[i+2,6] <- tab[1,2]
  # fill with proportion/percentage
  table3_matrix[i+2,7] <- tab_prop[1,2]
  # perform fisher's exact test; will be approximate to chisq with 
  # large enough sample size
  fisher_p <- tidy(fisher.test(tab)) %>% select(p.value)
  # fill in matrix
  table3_matrix[i + 2, 8] <- round(as.numeric(fisher_p), 3)
  
}

# convert table 1 matrix to dataframe
table3_df <- data.frame(table3_matrix)

knitr::kable(table3_df, caption = paste0("Table 3: Demographic and descriptive",
  " characteristics of ACPA positive subjects by incident Inflammatory Arthritis", 
  " (IA) status at baseline"))

```

### Association Between n-3 FA % in RBCs and Incident IA (Table 4)

Time-varying survival model that allows n-3 FA measure at each visit to contribute in the calculation of relative risk (hazard ratio; instantaenous risk of event).

```{r timevary regression loop, message=F, warning=F, results='asis'}
# create empty matrix for table
tab4_matrix <- matrix(nrow = 6, ncol = 5 )
# column names of tables
colnames(tab4_matrix) <- c("n3_FA_RBC", "HR", "Lower_95_CI",
                           "Upper_95_CI", "p_value") 
# variables to loop through
n3_vars <- c("sd_ala", "sd_epa", "sd_dpa", "sd_dha", "sd_epa_dha",
             "sd_total_n3")

# fill first column of matrix with n3 vars
tab4_matrix[,1] <- c("ALA", "EPA", "DPA", "DHA", "EPA+DHA",
                     "Total n-3 FA")

# Iteration of time varying model through n-3 FAs
for(i in 1:length(n3_vars)){

  # general logistc regression; using tidy from broom to output 
  # coeffecients
  tv_surv_mod <- tidy(coxph(as.formula(
    # formula for loop
    paste0("Surv(t1, t2, ia ==1) ~", 
    paste(n3_vars[i], "omega3_bi", "age_base_bi", "rfneph", 
    "crp", "se_bi", sep = "+"))),
    data = timevarying_df)) 
  

  # calculate hazard ratio and 95% CI
  hazard_ratio <- tv_surv_mod %>% filter(term == n3_vars[i]) %>% 
    # select terms to keep
    select(term, estimate, conf.low, conf.high, p.value)

  # fill ith row of table 2
  tab4_matrix[i,2:4] <- round(as.numeric(exp(hazard_ratio[1, 2:4])),2)
  tab4_matrix[i,5] <- round(as.numeric(hazard_ratio[1,5]),2)

}

# create table of logistic values
# convert table 1 matrix to dataframe
table4_df <- data.frame(tab4_matrix)


knitr::kable(table4_df, caption = paste0("Table 4: Association between increase in n-3",
  " fatty acid % in red blood cells (RBC) and incident inflammatory arthritis (IA) in ACPA",
  " positive subjects"))


```

